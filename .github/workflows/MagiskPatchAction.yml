name: MagiskPatchAction

on:
  workflow_dispatch:
    inputs:
      rom-url:
        description: 'ROM 下载直链'
        required: true
        default: 'https://mirrorbits.lineageos.org/full/tissot/20230214/lineage-19.1-20230214-nightly-tissot-signed.zip'
      CPU_TYPE:
        description: 'CPU type'
        required: false
      ANDROID_SDK:
        description: 'android sdk'
        required: true
        default: '32'
jobs:
  MagiskPatchAction:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v2

    - name: 安装依赖文件
      run: |
        sudo apt update
        sudo apt install -y wget unzip binwalk curl
        
        
    - name: 下载 ROM 并提取 Payload.bin
      id: download-rom
      run: |
        url=${{ github.event.inputs.rom-url }}
        curl --silent --location --remote-name "$url"
        # Check if payload.bin exists, and convert it to zip format if necessary
        if [ -f payload.bin ]; then
          mkdir payload
          dd if=payload.bin of=payload.zip bs=1 skip=202
          unzip payload.zip -d payload/
          cd payload/
        fi
        # Extract zip file
        unzip *.zip
        
    - name: 下载 Magisk
      run: |
        git clone https://github.com/tosasitill/MagiskPatchActionEXTRA.git
        cd MagiskPatchActionEXTRA/

        
    - name: 获取变量
      run: |
        echo "BUILD_TIME=$(date +%s | md5sum | awk '{print substr($1,1,10)}')" >> $GITHUB_ENV
        TYPE=${{ github.event.inputs.CPU_TYPE }}
        
    - name: 修补镜像
      run: |
        if [ -f init_boot.img ]; then
           sh '${{ github.workspace }}/payload/MagiskPatchActionEXTRA/boot_patch.sh' '${{ github.workspace }}/payload/init_boot.img' 
        else
           sh '${{ github.workspace }}/payload/MagiskPatchActionEXTRA/boot_patch.sh' '${{ github.workspace }}/payload/boot.img' 
        fi

    - name: 上传至 Github Releases
      uses: ncipollo/release-action@v1.12.0
      with:
          artifacts: "${{ github.workspace }}/payload/MagiskPatchActionEXTRA/new-boot.img"
          tag: "${{ env.BUILD_TIME }}"
          token: ${{ secrets.GITHUB_TOKEN }}
